---
- name: Add paperless-ngx user(s) and group(s)
  ansible.builtin.include_tasks:
    file: user.yml
    apply:
      tags: user
  tags: user

- name: Backup existing installation
  ansible.builtin.include_tasks:
    file: backup.yml
    apply:
      tags: backup
  tags: backup
  when:
    - _paperless_ngx_installation_strategy_upgrade
    - paperless_ngx_backup_on_upgrade

- name: Get paperless-ngx release
  ansible.builtin.include_tasks:
    file: release_get.yml
    apply:
      tags: release_get
  tags: release_get
  when: >-
    _paperless_ngx_installation_strategy_upgrade
    or
    _paperless_ngx_installation_strategy_fresh

# Before moving on, configure pngx to make ENV vars available to next steps
- name: Configure paperless-ngx
  ansible.builtin.include_tasks:
    file: configuration.yml
    apply:
      tags: configuration
  tags: configuration

- name: Prepare paperless-ngx release
  ansible.builtin.include_tasks:
    file: release_setup.yml
    apply:
      tags: release_setup
  tags: release_setup
  when: >-
    _paperless_ngx_installation_strategy_upgrade
    or
    _paperless_ngx_installation_strategy_fresh

- name: Finish paperless-ngx release
  ansible.builtin.include_tasks:
    file: release_finish.yml
    apply:
      tags: release_finish
  tags: release_finish
  when: >-
    _paperless_ngx_installation_strategy_upgrade
    or
    _paperless_ngx_installation_strategy_fresh
