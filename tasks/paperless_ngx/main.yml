---
- name: Add paperless-ngx user(s) and group(s)
  ansible.builtin.include_tasks:
    file: user.yml
    apply:
      tags: user
  tags: user

- name: Backup existing installation
  ansible.builtin.include_tasks:
    file: backup.yml
    apply:
      tags: backup
  tags: backup
  when: _paperless_ngx_installation_strategy_upgrade

- name: Pre configuration
  when: >-
    _paperless_ngx_installation_strategy_upgrade
    or
    _paperless_ngx_installation_strategy_fresh
  block:
    - name: Get paperless-ngx release files
      ansible.builtin.include_tasks:
        file: download.yml
        apply:
          tags: download
      tags: download

    - name: Prepare paperless-ngx virtual environment
      ansible.builtin.include_tasks:
        file: venv.yml
        apply:
          tags: venv
      tags: venv

- name: Configure paperless-ngx
  ansible.builtin.include_tasks:
    file: configuration.yml
    apply:
      tags: configuration
  tags: configuration

- name: Post configuration
  when: >-
    _paperless_ngx_installation_strategy_upgrade
    or
    _paperless_ngx_installation_strategy_fresh
  block:
    - name: Initialize and upgrade paperless-ngx release
      ansible.builtin.include_tasks:
        file: upgrade.yml
        apply:
          tags: upgrade
      tags: upgrade

    - name: Deploy systemd services
      ansible.builtin.include_tasks:
        file: services.yml
        apply:
          tags: services
      tags: services

    - name: Finish paperless-ngx release
      ansible.builtin.include_tasks:
        file: finish.yml
        apply:
          tags: finish
      tags: finish
